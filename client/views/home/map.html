<!-- MAP -->
<div class="google-map">
  <div id="map">
    <script>
      function initMap() {
        // Oulu centre 65.0136864,25.4775258
        var mapDiv = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 65.013, lng: 25.477},
          zoom: 12
        });
        var mapWindow = new google.maps.InfoWindow({map: mapDiv});

        // Try HTML5 geolocation.
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            mapWindow.setPosition(pos);
            mapWindow.setContent('You are here');
            mapDiv.setCenter(pos);

            // Place sound markers
            getAndParseSounds(mapDiv);

          }, function() {
            handleLocationError(true, mapWindow, mapDiv.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, mapWindow, mapDiv.getCenter());
        }
      }

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
          'Error: The Geolocation service failed.' :
          'Error: Your browser doesn\'t support geolocation.');
      }

      /**
       * Make an asynchronous call to the backend that fetches sounds.
       * When results are ready, place a marker on map for each sound.
       * The sound title is set to marker title
       *
       * @param map google.maps.Map object on which the markers are placed
       */
      function getAndParseSounds(map) {
        // TODO: Implement logic to only fetch nearby sounds
        var sounds;
        var xhttp = new XMLHttpRequest();

        xhttp.open("GET", "/sounds/get-all", true);
        xhttp.send();
        xhttp.onreadystatechange = function() {
          if (xhttp.readyState == 4 && xhttp.status == 200) {
            sounds = JSON.parse(xhttp.responseText);
            console.log(sounds);

            // Loop through the sounds and get place them on the map
            for (var i = 0; i < sounds.length; i++) {
              var curSound = sounds[i];
              var marker = new google.maps.Marker({
                position: { lat: parseFloat(curSound.lat), lng: parseFloat(curSound.long) },
                map: map,
                title: curSound.title,
                soundId: curSound.id
              });
              // Add click event listener to marker
              marker.addListener('click', playSound);
            }
          }
        };
      }

      function playSound() {
        //alert(this.soundId);

        // Pop the overlay and player window

        // Make request to download the sound

      }

    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAz7PBHLbH9Bh-sAJBOZ6-rQjULBf_1nys&callback=initMap">
    </script>
  </div>
</div>
